<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro e Login com Supabase</title>
  <style>
    /* Reset b√°sico e estilo responsivo para mobile */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background-color: #121212;
      color: #ffffff;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      min-height: 100vh;
    }
    h2, h1, h3 { margin-bottom: 15px; }
    form { width: 100%; max-width: 400px; margin-bottom: 20px; }
    input, textarea {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      background-color: #1e1e1e;
      color: #ffffff;
      border: 1px solid #333;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      width: 100%;
      max-width: 400px;
      padding: 12px;
      background-color: #6200ea;
      color: #ffffff;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover { background-color: #3700b3; }
    .container { width: 100%; max-width: 400px; margin: auto; text-align: center; }
    #mainContent { display: none; text-align: center; margin-top: 30px; }
    #msg { margin-top: 10px; font-size: 14px; }
    #msg.error { color: #ff4d4d; }
    #msg.success { color: #4dff4d; }
    .toggle-btn {
      margin-top: 10px;
      background: none;
      border: none;
      color: #bbb;
      text-decoration: underline;
      font-size: 14px;
      cursor: pointer;
    }
    #loveLinkActions { margin-top: 20px; }
    #deleteLoveLink {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      margin-left: 10px;
    }
    #deleteLoveLink:hover { color: red; }
    #loveLinkCreateScreen, #loveLinkEditScreen, #loveLinkDisplay { display: none; margin-top: 20px; }
    #loveLinkPhoto { max-width: 100%; border-radius: 5px; }
    #loveLinkCaption { margin-top: 10px; font-size: 16px; }
    #backToMain { margin-top: 20px; }
  </style>
</head>
<body>
  <div id="authSection" class="container">
    <!-- Se√ß√£o de Login -->
    <div id="loginSection">
      <h2>Login</h2>
      <form id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginSenha" placeholder="Senha" required>
        <button type="submit">Entrar</button>
      </form>
      <button id="btnGoCadastro" class="toggle-btn">N√£o tem conta? Se cadastre</button>
    </div>

    <!-- Se√ß√£o de Cadastro -->
    <div id="cadastroSection" style="display: none;">
      <h2>Cadastro</h2>
      <form id="cadastroForm">
        <input type="text" id="cadastroNome" placeholder="Nome" required>
        <input type="email" id="cadastroEmail" placeholder="Email" required>
        <input type="password" id="cadastroSenha" placeholder="Senha" required>
        <button type="submit">Criar Conta</button>
      </form>
      <button id="btnGoLogin" class="toggle-btn">J√° tem uma conta? Fa√ßa login</button>
    </div>
  </div>

  <div id="mainContent" class="container">
    <h1>Bem-vindo, <span id="userNome"></span>!</h1>
    <button id="btnCreateLoveLink" style="display: none;">Criar Love Link</button>
    <div id="loveLinkActions" style="display: none;">
      <button id="openLoveLink">Abrir Love Link</button>
      <button id="deleteLoveLink" title="Excluir Love Link">üóëÔ∏è</button>
      <br>
      <button id="editLoveLink">Editar Love Link</button>
    </div>
    <div id="loveLinkCreateScreen" class="container">
      <h3>Criar Love Link</h3>
      <input type="text" id="createPageName" placeholder="Nome da P√°gina" required>
      <input type="file" id="createPhoto" accept="image/*">
      <input type="text" id="createCaption" placeholder="Legenda da Foto">
      <button id="saveCreate">Salvar Love Link</button>
    </div>
    <div id="loveLinkEditScreen" class="container">
      <h3>Editar Love Link</h3>
      <input type="text" id="editPageName" placeholder="Nome da P√°gina" required>
      <input type="file" id="editPhoto" accept="image/*">
      <input type="text" id="editCaption" placeholder="Legenda da Foto">
      <button id="saveEdit">Salvar Altera√ß√µes</button>
    </div>
    <div id="loveLinkDisplay" class="container">
      <h3>Seu Love Link</h3>
      <img id="loveLinkPhoto" alt="Foto do Love Link">
      <p id="loveLinkCaption"></p>
      <button id="backToMain">Voltar</button>
    </div>
  </div>

  <div id="msg" class="container"></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

    const supabaseUrl = 'https://pegjlbpztozfoxzqwkhj.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlZ2psYnB6dG96Zm94enF3a2hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMzNjExOTAsImV4cCI6MjA1ODkzNzE5MH0.l6Haxm0WMkD1Ts1b1fFyE-4LLsSn-9ovDlIkrEb2gS8';
    const supabase = createClient(supabaseUrl, supabaseKey);
    const imgurClientId = 'YOUR_IMGUR_API_KEY'; // Substitua pelo seu Client-ID do Imgur
    const msg = document.getElementById('msg');
    const cadastroSection = document.getElementById('cadastroSection');
    const loginSection = document.getElementById('loginSection');
    const authSection = document.getElementById('authSection');
    const mainContent = document.getElementById('mainContent');
    const userNomeDisplay = document.getElementById('userNome');
    const btnCreateLoveLink = document.getElementById('btnCreateLoveLink');
    const loveLinkActions = document.getElementById('loveLinkActions');
    const openLoveLink = document.getElementById('openLoveLink');
    const deleteLoveLink = document.getElementById('deleteLoveLink');
    const editLoveLink = document.getElementById('editLoveLink');
    const loveLinkCreateScreen = document.getElementById('loveLinkCreateScreen');
    const loveLinkEditScreen = document.getElementById('loveLinkEditScreen');
    const loveLinkDisplay = document.getElementById('loveLinkDisplay');
    let currentLoveLink = null;

    // Fun√ß√£o para fazer upload de imagem para o Imgur
    async function uploadImageToImgur(file) {
      if (!file) return null;
      const formData = new FormData();
      formData.append('image', file);

      try {
        const response = await fetch('https://api.imgur.com/3/image', {
          method: 'POST',
          headers: {
            Authorization: `Client-ID ${imgurClientId}`
          },
          body: formData
        });

        if (!response.ok) throw new Error('Erro ao fazer upload da imagem para o Imgur');
        const data = await response.json();
        if (data.status !== 200) throw new Error('Erro no status da resposta do Imgur');
        return data.data.link;
      } catch (error) {
        throw new Error('Erro no upload: ' + error.message);
      }
    }

    // Alternar para a tela de cadastro
    document.getElementById('btnGoCadastro').addEventListener('click', () => {
      loginSection.style.display = 'none';
      cadastroSection.style.display = 'block';
      msg.textContent = '';
      msg.className = '';
    });

    // Alternar para a tela de login
    document.getElementById('btnGoLogin').addEventListener('click', () => {
      cadastroSection.style.display = 'none';
      loginSection.style.display = 'block';
      msg.textContent = '';
      msg.className = '';
    });

    // Cadastro de usu√°rio
    document.getElementById('cadastroForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const nome = document.getElementById('cadastroNome').value;
      const email = document.getElementById('cadastroEmail').value;
      const senha = document.getElementById('cadastroSenha').value;

      if (senha.length < 6) {
        msg.textContent = 'A senha deve ter pelo menos 6 caracteres.';
        msg.className = 'error';
        return;
      }

      try {
        const { data, error } = await supabase.auth.signUp({
          email,
          password: senha,
          options: { data: { nome } }
        });

        if (error) throw error;

        const user = data.user;
        const { error: profileError } = await supabase.from('profiles').insert([{ id: user.id, nome, email }]);

        if (profileError) throw profileError;

        msg.textContent = 'Cadastro realizado com sucesso! Fa√ßa login.';
        msg.className = 'success';
        cadastroSection.style.display = 'none';
        loginSection.style.display = 'block';
        this.reset();
      } catch (error) {
        msg.textContent = 'Erro no cadastro: ' + error.message;
        msg.className = 'error';
      }
    });

    // Login de usu√°rio
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const senha = document.getElementById('loginSenha').value;

      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password: senha });

        if (error) throw error;

        const { data: userData, error: userError } = await supabase.auth.getUser();
        if (userError) throw userError;

        authSection.style.display = 'none';
        mainContent.style.display = 'block';
        const nomeUsuario = userData.user.user_metadata.nome || email;
        userNomeDisplay.textContent = nomeUsuario;
        await checkLoveLink(); // Garantir que a verifica√ß√£o seja conclu√≠da
        msg.textContent = '';
        msg.className = '';
        this.reset();
      } catch (error) {
        msg.textContent = 'Erro no login: ' + error.message;
        msg.className = 'error';
      }
    });

    // Verificar se o usu√°rio j√° possui um Love Link
    async function checkLoveLink() {
      try {
        const user = await supabase.auth.getUser();
        const userId = user.data.user.id;
        const { data: loveLink, error } = await supabase
          .from('love_links')
          .select('*')
          .eq('user_id', userId)
          .maybeSingle(); // Usar maybeSingle para lidar com caso de nenhum resultado

        if (error && error.code !== 'PGRST116') { // Ignorar erro de "nenhum resultado"
          throw error;
        }

        if (loveLink) {
          currentLoveLink = loveLink;
          btnCreateLoveLink.style.display = 'none';
          loveLinkActions.style.display = 'block';
        } else {
          currentLoveLink = null;
          btnCreateLoveLink.style.display = 'block';
          loveLinkActions.style.display = 'none';
        }
      } catch (error) {
        msg.textContent = 'Erro ao verificar Love Link: ' + error.message;
        msg.className = 'error';
      }
    }

    // Criar Love Link
    btnCreateLoveLink.addEventListener('click', () => {
      loveLinkCreateScreen.style.display = 'block';
    });

    // Salvar novo Love Link
    document.getElementById('saveCreate').addEventListener('click', async () => {
      const user = await supabase.auth.getUser();
      const userId = user.data.user.id;
      const pageName = document.getElementById('createPageName').value;
      const photoFile = document.getElementById('createPhoto').files[0];
      const caption = document.getElementById('createCaption').value || '';

      if (!pageName) {
        msg.textContent = 'O nome da p√°gina √© obrigat√≥rio.';
        msg.className = 'error';
        return;
      }

      try {
        const photoUrl = await uploadImageToImgur(photoFile);
        const newLoveLink = {
          user_id: userId,
          page_name: pageName,
          photo: photoUrl,
          caption: caption
        };
        const { data, error } = await supabase.from('love_links').insert([newLoveLink]).select().single();
        if (error) throw error;

        currentLoveLink = data;
        msg.textContent = 'Love Link criado com sucesso!';
        msg.className = 'success';
        loveLinkCreateScreen.style.display = 'none';
        await checkLoveLink();
      } catch (error) {
        msg.textContent = 'Erro ao criar Love Link: ' + error.message;
        msg.className = 'error';
      }
    });

    // Abrir Love Link
    openLoveLink.addEventListener('click', async () => {
      if (!currentLoveLink) {
        await checkLoveLink(); // Re-verificar antes de abrir
      }
      if (currentLoveLink && currentLoveLink.page_name) {
        mainContent.style.display = 'none';
        loveLinkDisplay.style.display = 'block';
        document.getElementById('loveLinkPhoto').src = currentLoveLink.photo || 'https://via.placeholder.com/300x200?text=Sem+Foto';
        document.getElementById('loveLinkCaption').textContent = currentLoveLink.caption || 'Sem legenda';
      } else {
        msg.textContent = 'Nenhum Love Link encontrado. Crie um primeiro!';
        msg.className = 'error';
      }
    });

    // Voltar para a tela principal
    document.getElementById('backToMain').addEventListener('click', () => {
      loveLinkDisplay.style.display = 'none';
      mainContent.style.display = 'block';
    });

    // Excluir Love Link
    deleteLoveLink.addEventListener('click', async () => {
      if (confirm('Tem certeza que deseja excluir o Love Link?')) {
        const { error } = await supabase.from('love_links').delete().eq('id', currentLoveLink.id);
        if (error) {
          msg.textContent = 'Erro ao excluir Love Link: ' + error.message;
          msg.className = 'error';
        } else {
          msg.textContent = 'Love Link exclu√≠do com sucesso!';
          msg.className = 'success';
          currentLoveLink = null;
          await checkLoveLink();
        }
      }
    });

    // Editar Love Link
    editLoveLink.addEventListener('click', () => {
      if (currentLoveLink) {
        loveLinkEditScreen.style.display = 'block';
        document.getElementById('editPageName').value = currentLoveLink.page_name;
        document.getElementById('editCaption').value = currentLoveLink.caption || '';
      } else {
        msg.textContent = 'Nenhum Love Link para editar.';
        msg.className = 'error';
      }
    });

    // Salvar altera√ß√µes do Love Link
    document.getElementById('saveEdit').addEventListener('click', async () => {
      const pageName = document.getElementById('editPageName').value;
      const photoFile = document.getElementById('editPhoto').files[0];
      const caption = document.getElementById('editCaption').value || '';

      if (!pageName) {
        msg.textContent = 'O nome da p√°gina √© obrigat√≥rio.';
        msg.className = 'error';
        return;
      }

      try {
        let photoUrl = currentLoveLink.photo;
        if (photoFile) {
          photoUrl = await uploadImageToImgur(photoFile);
        }
        const updatedData = {
          page_name: pageName,
          photo: photoUrl,
          caption: caption
        };
        const { error } = await supabase.from('love_links').update(updatedData).eq('id', currentLoveLink.id);
        if (error) throw error;

        msg.textContent = 'Love Link atualizado com sucesso!';
        msg.className = 'success';
        loveLinkEditScreen.style.display = 'none';
        await checkLoveLink();
      } catch (error) {
        msg.textContent = 'Erro ao atualizar Love Link: ' + error.message;
        msg.className = 'error';
      }
    });
  </script>
</body>
</html>
